!function(){"use strict";const e=[239,187,191];var t={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const o=new Uint8Array(16);function a(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(o)}const r=[];for(let e=0;e<256;++e)r.push((e+256).toString(16).slice(1));var i=function(e,n,o){if(t.randomUUID&&!n&&!e)return t.randomUUID();const i=(e=e||{}).random||(e.rng||a)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,n){o=o||0;for(let e=0;e<16;++e)n[o+e]=i[e];return n}return function(e,t=0){return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}(i)};let s,c;const l={standard:"A network or API error occurred! Please wait a minute and try again.",prompt:"Invalid prompt.",denied:"ChatGPT denied this request. Please wait a minute before sending another request.",abort:"User aborted search.",timeout:"ChatGPT isn't responding right now. Please try again later."};async function u(t,n,o){let a,r=null,u=!1,d=Date.now();const p=o?"Limit your response to 130 characters:\n"+n:n;try{if(null==n||""===n.trim())throw new Error("prompt");s=new AbortController,c=setTimeout((()=>s.abort("timeout")),3e3);const o=await async function(e,t){const n=await fetch("https://chat.openai.com/backend-api/models",{method:"GET",signal:null==t?null:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});return(await n.json()).models[0].slug}(t,s);return clearTimeout(c),c=setTimeout((()=>s.abort("timeout")),15e3),await async function(t,o,i){const s=await fetch("https://chat.openai.com/backend-api/conversation",o);if(!s.ok)throw new Error("fetch");const l=function(t){let n,o,a,r,i,s,c;return l(),{feed:function(t){o=o?o+t:t,n&&function(t){return e.every(((e,n)=>t.charCodeAt(n)===e))}(o)&&(o=o.slice(e.length)),n=!1;const i=o.length;let s=0,c=!1;for(;s<i;){c&&("\n"===o[s]&&++s,c=!1);let e,t=-1,n=r;for(let r=a;t<0&&r<i;++r)e=o[r],":"===e&&n<0?n=r-s:"\r"===e?(c=!0,t=r-s):"\n"===e&&(t=r-s);if(t<0){a=i-s,r=n;break}a=0,r=-1,u(o,s,n,t),s+=t+1}s===i?o="":s>0&&(o=o.slice(s))},reset:l};function l(){n=!0,o="",a=0,r=-1,i=void 0,s=void 0,c=""}function u(e,n,o,a){if(0===a)return c.length>0&&(t({type:"event",id:i,event:s||void 0,data:c.slice(0,-1)}),c="",i=void 0),void(s=void 0);const r=o<0,l=e.slice(n,n+(r?a:o));let u=0;u=r?a:" "===e[n+o+1]?o+2:o+1;const d=n+u,p=a-u,m=e.slice(d,d+p).toString();if("data"===l)c+=m?"".concat(m,"\n"):"\n";else if("event"===l)s=m;else if("id"!==l||m.includes("\0")){if("retry"===l){const e=parseInt(m,10);Number.isNaN(e)||t({type:"reconnect-interval",value:e})}}else i=m}}((e=>{"event"===e.type&&(e=>{if("[DONE]"!==e)try{const t=JSON.parse(e);u||(clearTimeout(c),u=!0),r!=t.conversation_id&&(r=t.conversation_id),a=t.message.content.parts[0];const o=Date.now();o-d>250&&(f("query",[n,t.message.content.parts[0],!1]),d=o)}catch(e){return}})(e.data)}));for await(const e of async function*(e){const t=e.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)return;yield n}}finally{t.releaseLock()}}(s.body)){const t=(new TextDecoder).decode(e);l.feed(t)}}(0,{method:"POST",signal:null==s?null:s.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({action:"next",messages:[{id:i(),role:"user",content:{content_type:"text",parts:[p]}}],model:o,parent_message_id:i()})}),c=setTimeout((()=>s.abort("timeout")),3e3),await async function(e,t,n){await fetch("https://chat.openai.com/backend-api/conversation/"+e,{method:"PATCH",signal:null==n?null:n.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({is_visible:!1})})}(r,t,s),clearTimeout(c),[a,!1]}catch(e){return clearTimeout(c),null==s||"prompt"===e.message?[l.prompt,!0]:"user"===s.signal.reason?[l.abort,!0]:"timeout"===s.signal.reason?[l.timeout,!0]:"fetch"===e.message?[l.denied,!0]:[l.standard,!0]}}chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.type){case"callAPI":return d(e),!0;case"abort":console.log("aborted"),s&&s.abort("user")}}));const d=async e=>{await f("loading","true"),await f("query",[e.query,null,!1]);const t=await h("accessToken"),n=await u(t,e.query,!1);await f("query",[e.query,n[0],n[1]]),await f("loading","false")};chrome.contextMenus.onClicked.addListener((async e=>{"3"===e.menuItemId?await async function(e){const t=await h("loading");if(null==t||"false"===t){const t=new AbortController;setTimeout((()=>t.abort("timeout")),5e3);try{const n=await fetch("https://chat.openai.com/api/auth/session",{signal:null==t?null:t.signal});if(403===n.status)m("Error!!!","Open the GptGO popup and sign in before sending search requests");else{const t=await n.json().catch((()=>({})));if(t.accessToken){await f("loading","true"),await f("query",[e.selectionText,null,!1]);const n=await u(t.accessToken,e.selectionText,!0);await f("query",[e.selectionText,n[0],n[1]]),await f("loading","false"),m(!0===n[1]?"Error!!!":"Response to: "+e.selectionText,n[0].replace(/\n/g,""))}else m("Error!!!","Open the GptGO popup and sign in before sending search requests")}}catch(e){console.log(e),m("Error!!!","ChatGPT took too long to respond")}}}(e):await p(e)}));const p=async e=>{const t=await h("loading");null!=t&&"false"!==t||await f("query",[e.selectionText,null,!1])},m=(e,t)=>{chrome.notifications.create("",{title:e,type:"basic",message:t,iconUrl:"images/logo192.png"})},h=async e=>(await chrome.storage.local.get([e]))[e],f=async(e,t)=>{await chrome.storage.local.set({[e]:t})};chrome.runtime.onInstalled.addListener((async e=>{"install"===e.reason&&chrome.runtime.openOptionsPage(),("install"===e.reason||"update"===e.reason)&&chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL("https://docs.google.com/forms/d/e/1FAIpQLSdv3c9RmDmphP1pihYgmNmV6DJ_UxMXq6NNi1oOW5XsIhyxOg/viewform?usp=sf_link"),"update"===e.reason&&"true"==await h("loading")&&f("loading","false")})),chrome.contextMenus.removeAll((()=>{chrome.contextMenus.create({id:"3",title:"Search + get response as notification",contexts:["selection"]}),chrome.contextMenus.create({id:"4",title:"Send text to popup",contexts:["selection"]})}))}();