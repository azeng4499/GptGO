!function(){"use strict";const e=[239,187,191];var t={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const o=new Uint8Array(16);function a(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(o)}const r=[];for(let e=0;e<256;++e)r.push((e+256).toString(16).slice(1));var i=function(e,n,o){if(t.randomUUID&&!n&&!e)return t.randomUUID();const i=(e=e||{}).random||(e.rng||a)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,n){o=o||0;for(let e=0;e<16;++e)n[o+e]=i[e];return n}return function(e,t=0){return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}(i)};chrome.runtime.onInstalled.addListener((async e=>{"install"===e.reason&&chrome.runtime.openOptionsPage(),("install"===e.reason||"update"===e.reason)&&(chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL("https://docs.google.com/forms/d/e/1FAIpQLSdv3c9RmDmphP1pihYgmNmV6DJ_UxMXq6NNi1oOW5XsIhyxOg/viewform?usp=sf_link"),await d("lock",!1),await d("apiKey",null),await d("accessToken",null),await d("convoInfo",null),await d("gpt4-info",[!1,!1]))})),chrome.contextMenus.removeAll((()=>{chrome.contextMenus.create({id:"Search + get response as notification",title:"Search + get response as notification",contexts:["selection"]}),chrome.contextMenus.create({id:"Send text to popup",title:"Send text to popup",contexts:["selection"]})})),chrome.runtime.onMessage.addListener((e=>{if("query"===e.type)return s(e),!0}));const s=async e=>{!1===await p("lock")&&await d("query",[e.payload,null])};chrome.contextMenus.onClicked.addListener((async e=>{if(!1===await p("lock"))if("Search + get response as notification"===e.menuItemId){let t;d("lock",!0);const n=new AbortController;setTimeout((()=>n.abort("timeout")),5e3);try{const o=await fetch("https://chat.openai.com/api/auth/session",{signal:null==n?null:n.signal});if(403===o.status){const n=await p("apiKey");null!=n?(t=await c(e,n,"api"),await d("notfiReady",[e.selectionText,t[0],t[1]])):u("Error!!!","Open the GptGO popup and sign in before sending search requests")}else{const n=await o.json().catch((()=>({})));n.accessToken?(await d("accessToken",n.accessToken),t=await c(e,n.accessToken,"access"),await d("notfiReady",[e.selectionText,t[0],t[1]])):u("Error!!!","Open the GptGO popup and sign in before sending search requests")}}catch(e){console.log(e),u("Error!!!","There was a problem connecting to ChatGPT")}finally{d("lock",!1)}}else await d("query",[e.selectionText,null])}));const c=async(t,n,o)=>{let a;return await d("query",[t.selectionText,null]),a="access"===o?await async function(t,n){let o,a,r=null,s=!1;const c="Limit your response to 130 characters:\n"+n;try{if(null==n||""===n.trim())throw new Error("prompt");const l=new AbortController;a=setTimeout((()=>l.abort("timeout")),3e3);const u=await async function(e,t){const n=await fetch("https://chat.openai.com/backend-api/models",{method:"GET",signal:null==t?null:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});return(await n.json()).models[0].slug}(t,l);return clearTimeout(a),a=setTimeout((()=>l.abort("timeout")),15e3),await async function(t,n,c,l,u){const p=await fetch("https://chat.openai.com/backend-api/conversation",{method:"POST",signal:null==t?null:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({action:"next",messages:[{id:i(),role:"user",content:{content_type:"text",parts:[c]}}],model:l,parent_message_id:i()})});if(!p.ok)throw new Error("fetch");const d=function(t){let n,o,a,r,i,s,c;return l(),{feed:function(t){o=o?o+t:t,n&&function(t){return e.every(((e,n)=>t.charCodeAt(n)===e))}(o)&&(o=o.slice(e.length)),n=!1;const i=o.length;let s=0,c=!1;for(;s<i;){c&&("\n"===o[s]&&++s,c=!1);let e,t=-1,n=r;for(let r=a;t<0&&r<i;++r)e=o[r],":"===e&&n<0?n=r-s:"\r"===e?(c=!0,t=r-s):"\n"===e&&(t=r-s);if(t<0){a=i-s,r=n;break}a=0,r=-1,u(o,s,n,t),s+=t+1}s===i?o="":s>0&&(o=o.slice(s))},reset:l};function l(){n=!0,o="",a=0,r=-1,i=void 0,s=void 0,c=""}function u(e,n,o,a){if(0===a)return c.length>0&&(t({type:"event",id:i,event:s||void 0,data:c.slice(0,-1)}),c="",i=void 0),void(s=void 0);const r=o<0,l=e.slice(n,n+(r?a:o));let u=0;u=r?a:" "===e[n+o+1]?o+2:o+1;const p=n+u,d=a-u,m=e.slice(p,p+d).toString();if("data"===l)c+=m?"".concat(m,"\n"):"\n";else if("event"===l)s=m;else if("id"!==l||m.includes("\0")){if("retry"===l){const e=parseInt(m,10);Number.isNaN(e)||t({type:"reconnect-interval",value:e})}}else i=m}}((e=>{"event"===e.type&&(e=>{if("[DONE]"!==e)try{const t=JSON.parse(e);s||(clearTimeout(a),s=!0),r!=t.conversation_id&&(r=t.conversation_id),o=t.message.content.parts[0]}catch(e){return}})(e.data)}));for await(const e of async function*(e){const t=e.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)return;yield n}}finally{t.releaseLock()}}(p.body)){const t=(new TextDecoder).decode(e);d.feed(t)}}(l,t,c,u),a=setTimeout((()=>l.abort("timeout")),3e3),await async function(e,t,n){await fetch("https://chat.openai.com/backend-api/conversation/"+e,{method:"PATCH",signal:null==n?null:n.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({is_visible:!1})})}(r,t,l),clearTimeout(a),[o,!1]}catch(e){return console.log(e),clearTimeout(a),["A network or API error occurred!",!0]}}(n,t.selectionText):await l(n,t.selectionText),!0===a[1]?await d("query",[t.selectionText,"\n\n```error\nðŸ›‘ A network or API error occurred! ðŸ›‘\n```"]):await d("query",[t.selectionText,a[0]]),u(!0===a[1]?"Error!!!":"Response to: "+t.selectionText,a[0].replace(/\n/g,"")),a},l=async(e,t)=>{try{const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:t}]})});return[(await n.json()).choices[0].message.content,!1]}catch(e){return console.log(e),["A network or API error occurred!",!0]}},u=(e,t)=>{chrome.notifications.create("",{title:e,type:"basic",message:t,iconUrl:"images/logo192.png"})},p=async e=>(await chrome.storage.local.get([e]))[e],d=async(e,t)=>{await chrome.storage.local.set({[e]:t})}}();